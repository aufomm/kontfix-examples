name: Daily Renewal Check

on:
  schedule:
    # Run every day at 9:00 AM UTC
    - cron: "0 13 * * *"
  workflow_dispatch:

concurrency:
  group: renewal-check
  cancel-in-progress: true

jobs:
  renewal-check:
    runs-on: self-hosted
    permissions:
      contents: read
      actions: read
      issues: write
    env:
      TF_VAR_cp_admin_token: ${{ secrets.CP_ADMIN_TOKEN }}
      TF_VAR_id_admin_token: ${{ secrets.ID_ADMIN_TOKEN }}
      TF_VAR_vault_role_id: ${{ secrets.vault_role_id }}
      TF_VAR_vault_secret_id: ${{ secrets.vault_secret_id }}
      TF_VAR_vault_pki_role_id: ${{ secrets.vault_pki_role_id }}
      TF_VAR_vault_pki_secret_id: ${{ secrets.vault_pki_secret_id }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_ENDPOINT_URL_S3: ${{ secrets.AWS_ENDPOINT_URL_S3 }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v20
      - name: Run Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v13

      - name: Start Renewal Check
        run: |
          echo "ðŸ” Starting certificate renewal check..."

      - name: Generate Renewal Plan
        id: generate-plan
        run: |
          echo "ðŸ” Generating renewal plan..."
          nix run .#ci-plan

          if [ ! -f plan.json ]; then
            echo "âŒ Plan file not found"
            exit 1
          fi

          echo "âœ… Plan generated successfully"

      - name: Parse Token and Certificate Changes
        id: parse-changes
        run: |
          echo "ðŸ“Š Analyzing plan for token rotations and certificate renewals..."

          # Parse plan.json for TLS self-signed certificates that need replacement
          TLS_RENEWALS=$(nix run nixpkgs#jq -- -r '
            .resource_changes[]? |
            select(.change.actions | contains(["delete", "create"])) |
            select(.address | test("tls_self_signed_cert")) |
            .address
          ' plan.json)

          # Parse for Vault PKI certificates with auto_renew
          VAULT_RENEWALS=$(nix run nixpkgs#jq -- -r '
            .resource_changes[]? |
            select(.change.actions | contains(["update"])) |
            select(.address | test("vault_pki_secret_backend_cert")) |
            .address
          ' plan.json)

          # Parse for Konnect system account access token rotations
          TOKEN_ROTATIONS=$(nix run nixpkgs#jq -- -r '
            .resource_changes[]? |
            select(.change.actions | contains(["delete", "create"])) |
            select(.address | test("konnect_system_account_access_token")) |
            .address
          ' plan.json)

          # Set variables for detection
          if [[ -n "$TLS_RENEWALS" || -n "$VAULT_RENEWALS" ]]; then
            renewal_detected="true"
            echo "renewal_detected=true" >> $GITHUB_OUTPUT
            echo "ðŸ”„ Certificate renewal changes detected!"
            if [[ -n "$TLS_RENEWALS" ]]; then
              {
                echo "TLS_RENEWALS<<EOF"
                echo "$TLS_RENEWALS"
                echo "EOF"
              } >> $GITHUB_OUTPUT
            fi
            if [[ -n "$VAULT_RENEWALS" ]]; then
              {
                echo "VAULT_RENEWALS<<EOF"
                echo "$VAULT_RENEWALS"
                echo "EOF"
              } >> $GITHUB_OUTPUT
            fi
          else
            renewal_detected="false"
            echo "renewal_detected=false" >> $GITHUB_OUTPUT
          fi

          if [[ -n "$TOKEN_ROTATIONS" ]]; then
            token_rotation_detected="true"
            echo "token_rotation_detected=true" >> $GITHUB_OUTPUT
            {
              echo "TOKEN_ROTATIONS<<EOF"
              echo "$TOKEN_ROTATIONS"
              echo "EOF"
            } >> $GITHUB_OUTPUT
            echo "ðŸ”„ Token rotation changes detected!"
            echo "ðŸ”‘ Konnect tokens needing rotation:"
            echo "$TOKEN_ROTATIONS" | while IFS= read -r token; do
              echo "  - $token"
            done
          else
            token_rotation_detected="false"
            echo "token_rotation_detected=false" >> $GITHUB_OUTPUT
          fi

          # Determine the action needed using properly set local bash variables
          if [[ "$renewal_detected" == "false" && "$token_rotation_detected" == "true" ]]; then
            echo "action=auto_rotate_tokens" >> $GITHUB_OUTPUT
            echo "ðŸŽ¯ Action: Automatic token rotation (no certificate changes)"
          elif [[ "$renewal_detected" == "true" ]]; then
            echo "action=manual_issue" >> $GITHUB_OUTPUT
            echo "ðŸŽ¯ Action: Create issue for manual review (includes both tokens and certificates)"
          else
            echo "action=no_changes" >> $GITHUB_OUTPUT
            echo "ðŸŽ¯ Action: No changes needed"
          fi

      - name: Automatic Token Rotation
        if: steps.parse-changes.outputs.action == 'auto_rotate_tokens'
        run: |
          echo "## ðŸ”‘ Automatic Token Rotation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“‹ Tokens Being Rotated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Action | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|--------|" >> $GITHUB_STEP_SUMMARY

          # Use the already parsed token data
          echo "${{ steps.parse-changes.outputs.TOKEN_ROTATIONS }}" | while IFS= read -r token; do
            if [[ -n "$token" ]]; then
              echo "| $token | konnect_system_account_access_token | Automatic rotation |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "ðŸ”„ **Applying token rotation...**" >> $GITHUB_STEP_SUMMARY
          echo "This is a safe automatic rotation - no certificate changes detected." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "âœ… **Starting token rotation...**"
          nix run .#ci-apply

          echo "ðŸŽ‰ **Token rotation completed successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY

      - name: Generate Manual Renewal Summary
        if: steps.parse-changes.outputs.action == 'manual_issue'
        run: |
          echo "## ðŸ” Manual Renewal Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Show tokens if they need rotation
          if [[ "${{ steps.parse-changes.outputs.token_rotation_detected }}" == "true" ]]; then
            echo "### ðŸ”‘ Tokens Requiring Rotation" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Resource | Action | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|--------|--------|" >> $GITHUB_STEP_SUMMARY

            echo "${{ steps.parse-changes.outputs.TOKEN_ROTATIONS }}" | while IFS= read -r token; do
              if [[ -n "$token" ]]; then
                echo "| $token | konnect_system_account_access_token | Manual rotation required |" >> $GITHUB_STEP_SUMMARY
              fi
            done
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Show certificates if they need renewal
          if [[ "${{ steps.parse-changes.outputs.renewal_detected }}" == "true" ]]; then
            echo "### ðŸ” Certificates Requiring Renewal" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # TLS certificates
            if [[ -n "${{ steps.parse-changes.outputs.TLS_RENEWALS }}" ]]; then
              echo "**TLS Self-Signed Certificates:**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "${{ steps.parse-changes.outputs.TLS_RENEWALS }}" | while IFS= read -r cert; do
                if [[ -n "$cert" ]]; then
                  echo "| $cert | tls_self_signed_cert | Manual renewal required |" >> $GITHUB_STEP_SUMMARY
                fi
              done
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            # Vault certificates
            if [[ -n "${{ steps.parse-changes.outputs.VAULT_RENEWALS }}" ]]; then
              echo "**Vault PKI Certificates:**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "${{ steps.parse-changes.outputs.VAULT_RENEWALS }}" | while IFS= read -r cert; do
                if [[ -n "$cert" ]]; then
                  echo "| $cert | vault_pki_secret_backend_cert | Manual renewal required |" >> $GITHUB_STEP_SUMMARY
                fi
              done
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "### ðŸŽ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Manual intervention required** - review all changes above" >> $GITHUB_STEP_SUMMARY
          echo "1. **Manual Apply** - Run the apply workflow to rotate tokens and renew certificates" >> $GITHUB_STEP_SUMMARY
          echo "2. **Monitor** the rotation and renewal process after application" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY

      
      - name: Create GitHub Issue for Manual Renewal
        if: steps.parse-changes.outputs.action == 'manual_issue'
        uses: actions/github-script@v7
        with:
          script: |
            // Build details from parsed data
            let tlsDetails = '';
            let vaultDetails = '';
            let tokenDetails = '';
            let titlePrefix = 'ðŸ” Manual Renewal Required';

            const fs = require('fs');
            const planJson = fs.readFileSync('plan.json', 'utf8');
            const plan = JSON.parse(planJson);

            // Parse TLS certificates from plan
            const tlsCerts = plan.resource_changes?.filter(rc =>
              rc.change.actions.includes('delete') &&
              rc.change.actions.includes('create') &&
              rc.address.includes('tls_self_signed_cert')
            ) || [];

            if (tlsCerts.length > 0) {
              tlsDetails = `
                ðŸ” **TLS Self-Signed Certificates:**
                ${tlsCerts.map(rc => `- \`${rc.address}\``).join('\n')}

              `;
            }

            // Parse Vault certificates from plan
            const vaultCerts = plan.resource_changes?.filter(rc =>
              rc.change.actions.includes('update') &&
              rc.address.includes('vault_pki_secret_backend_cert')
            ) || [];

            if (vaultCerts.length > 0) {
              vaultDetails = `
                ðŸ” **Vault PKI Certificates:**
                ${vaultCerts.map(rc => `- \`${rc.address}\``).join('\n')}

              `;
            }

            // Parse tokens from plan
            const tokenCerts = plan.resource_changes?.filter(rc =>
              rc.change.actions.includes('delete') &&
              rc.change.actions.includes('create') &&
              rc.address.includes('konnect_system_account_access_token')
            ) || [];

            if (tokenCerts.length > 0) {
              tokenDetails = `
                ðŸ”‘ **Tokens Requiring Rotation:**
                ${tokenCerts.map(rc => `- \`${rc.address}\``).join('\n')}

              `;
            }

            // Determine title based on what needs renewal
            if (tokenCerts.length > 0 && (tlsCerts.length > 0 || vaultCerts.length > 0)) {
              titlePrefix = 'ðŸ”„ Mixed Renewal - Tokens + Certificates';
            } else if (tokenCerts.length > 0) {
              titlePrefix = 'ðŸ”‘ Token Rotation Required';
            } else {
              titlePrefix = 'ðŸ” Certificate Renewal Required';
            }

            // Create the issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `${titlePrefix} - ${new Date().toISOString().split('T')[0]}`,
              labels: ['infrastructure', 'certificates', 'automation'],
              body: `
                ## ${titlePrefix}

                **Date:** ${new Date().toISOString()}
                **Repository:** ${context.repo.owner}/${context.repo.repo}
                **Workflow:** [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

                ### ðŸ“‹ Resources Requiring Attention

                ${tokenDetails}
                ${tlsDetails}
                ${vaultDetails}

                ### ðŸŽ¯ Required Actions

                1. **Review** all the changes above
                2. **Manual Apply** - Run the apply workflow to rotate tokens and renew certificates
                3. **Monitor** - Verify successful rotation and renewal after application

                ### ðŸ”„ Next Steps

                - [ ] Run the apply workflow to handle all renewals
                - [ ] Monitor the rotation and renewal process
                - [ ] Verify all resources are successfully updated
                - [ ] Close this issue once completed

                ### ðŸ“Š Summary

                **Total resources needing attention:** ${tokenCerts.length + tlsCerts.length + vaultCerts.length}
                ${tokenCerts.length > 0 ? `- Konnect Tokens: ${tokenCerts.length}` : ''}
                ${tlsCerts.length > 0 ? `- TLS Self-Signed: ${tlsCerts.length}` : ''}
                ${vaultCerts.length > 0 ? `- Vault PKI: ${vaultCerts.length}` : ''}

                ---
                ðŸ¤– *This issue was automatically created by GitHub Actions*
                *Last check: ${new Date().toISOString()}*
              `.trim()
            });

            console.log(`âœ… Created issue for ${tokenCerts.length + tlsCerts.length + vaultCerts.length} resource renewals`);

      - name: No Renewals Needed
        if: steps.parse-changes.outputs.token_rotation_detected == 'false' && steps.parse-changes.outputs.renewal_detected == 'false'
        run: |
          echo "## âœ… All Certificates and Tokens Up to Date" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **Good news!** No certificate renewals or token rotations are needed at this time." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Summary" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… TLS self-signed certificates: All within rotation period" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Vault PKI certificates: All valid with auto-renew working" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Konnect access tokens: All within rotation period" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… No manual intervention required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Next check: Tomorrow at 1:00 PM UTC" >> $GITHUB_STEP_SUMMARY
