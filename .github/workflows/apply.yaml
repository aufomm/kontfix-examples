name: Terraform Apply

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number (for reference/documentation only)"
        required: false
        type: string
      confirmation:
        description: 'Type "apply" to confirm deployment'
        required: true
        type: string

  pull_request:
    types: [closed]
    branches: [main]
    paths:
      - "konnect/**"
      - "flake.nix"
      - "flake.lock"
      - "custom-plugin-schemas/*"

concurrency:
  group: terraform-apply
  cancel-in-progress: false

jobs:
  apply:
    runs-on: self-hosted
    if: |
      (github.event_name == 'pull_request' && 
       github.event.pull_request.merged == true &&
       contains(github.event.pull_request.labels.*.name, 'terraform:auto-deploy')) ||
      (github.event_name == 'workflow_dispatch')
    permissions:
      contents: read
      pull-requests: read
    env:
      TF_VAR_cp_admin_token: ${{ secrets.CP_ADMIN_TOKEN }}
      TF_VAR_id_admin_token: ${{ secrets.ID_ADMIN_TOKEN }}
      TF_VAR_vault_role_id: ${{ secrets.vault_role_id }}
      TF_VAR_vault_secret_id: ${{ secrets.vault_secret_id }}
      TF_VAR_vault_pki_role_id: ${{ secrets.vault_pki_role_id }}
      TF_VAR_vault_pki_secret_id: ${{ secrets.vault_pki_secret_id }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_ENDPOINT_URL_S3: ${{ secrets.AWS_ENDPOINT_URL_S3 }}

    steps:
      - name: Validate manual trigger confirmation
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ github.event.inputs.confirmation }}" != "apply" ]; then
            echo "‚ùå Error: You must type 'apply' to confirm deployment"
            echo "You entered: '${{ github.event.inputs.confirmation }}'"
            exit 1
          fi
          echo "‚úÖ Manual trigger confirmation validated"

      - name: Log deployment info
        run: |
          echo "## üöÄ Terraform Apply" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "- **PR:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
            echo "- **PR Title:** ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Deploy Mode:** ü§ñ Automatic (label-triggered)" >> $GITHUB_STEP_SUMMARY
          elif [ -n "${{ github.event.inputs.pr_number }}" ]; then
            echo "- **Related PR:** #${{ github.event.inputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Deploy Mode:** üë§ Manual" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Deploy Mode:** üë§ Manual" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.merge_commit_sha || github.sha }}

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v20
      - name: Run Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v13

      - name: Run Terraform Apply
        id: apply
        run: nix run .#ci-apply

      - name: Generate Apply Summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.apply.outcome }}" == "success" ]; then
            echo "## ‚úÖ Deployment Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure has been successfully updated." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The deployment encountered an error. Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
      - name: Comment on PR (if auto-deployed)
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.apply.outcome }}' === 'success' ? '‚úÖ Deployed' : '‚ùå Failed';
            const icon = '${{ steps.apply.outcome }}' === 'success' ? 'üöÄ' : 'üí•';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            const comment = `${icon} **Terraform Apply ${status}**
            
            Triggered by merge of this PR with \`terraform:auto-deploy\` label.
            
            [View deployment logs](${runUrl})
            
            **Commit:** ${context.sha.substring(0, 7)}
            **Time:** ${new Date().toISOString()}`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      - name: Upload apply logs
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: terraform-apply-${{ github.event.pull_request.number || github.run_number }}
          path: |
            config.tf.json
          retention-days: 90
